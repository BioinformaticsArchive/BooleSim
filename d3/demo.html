<html>

<head>
	<script src="d3.v2.js"></script>
	<script src="paper.net.js"></script>
	<script src="convert.js"></script>
	<script>
		network = jSBGN_to_d3( JSON.parse(jSBGN_network) );
	</script>

	<style>
		body		{
				overflow:	hidden;
				}
		.edge	{
				stroke: #999;
				stroke-opacity: .6;
				stroke-width: 1.6px;
				}
		.rect		{
				fill: green;
				}
		.label	{
				fill: black;
				font-family: Arial;
				}
	</style>
</head>

<body>
	<script>

		// d3 setup
		var	svg_width = window.innerWidth,
			svg_height = window.innerHeight;

		var force = d3.layout.force()
							.charge(-500)
							.linkDistance(50)
							.size([svg_width, svg_height]);

		var svg = d3.select("body").append("svg")
									.attr("width", svg_width)
									.attr("height", svg_height);

		console.log("d3 setup complete.");

		// setup arrow
		arrow = svg.append("defs").append("marker");
		arrow.attr('id', 'arrow').attr('orient', 'auto').attr('markerWidth', 10).attr('markerHeight', 10).attr('refX', 20).attr('refY', 3);
		arrow.append('path').attr('d', 'M0,0 V6 L4,3 Z').attr('fill', 'blue');

		console.log(network.nodes.length+' nodes')
		console.log(network.edges.length+' edges');

		// import data to d3 force-directed layouting
		force
		      .nodes(network.nodes)
		      .links(network.edges)
		      .start();

		console.log("data import complete.");

		var edges = svg.selectAll("line.edge")
						.data(network.edges).enter()
							.append("line")
							.attr("class", "edge")		// add class link for application of css style attributes
							.attr('marker-end', 'url(#arrow)');

		// layers: <g> elements
		var w = 70;
		var h = 30;
		var nodes = svg.selectAll("g").data(network.nodes)	// selectAll.data = apply the data in network.nodes to the selected svg elements, which already exist
											.enter()	// for remaining unapplied data do:
												.append("g")
													.attr("class", "node")
													.attr("id", function(data) { return data.id; });
		// drag'n'drop handler
		nodes	.call(force.drag);

		var rects =	nodes
						.append("rect")
						.attr("class", "rect")
						.attr("width", w)
						.attr("height",  h)
						.attr("rx", 5);

		var labels =	nodes
						.append("text")
						.attr("class", "label")
						.attr("transform", "translate(10, "+h/2+")")	// move text inside the rect
						.text( function(data) { return data.id; } );

		// on every x|y update do:
		force.on("tick", function() {
							    edges	.attr("x1", function(data) { return data.sourceNode.x+w/2; })
									.attr("y1", function(data) { return data.sourceNode.y+h/2; })
									.attr("x2", function(data) { return data.targetNode.x+w/2; })
									.attr("y2", function(data) { return data.targetNode.y+h/2; });

							    rects	.attr("x", function(data) { return data.x; })
									.attr("y", function(data) { return data.y; });

							    labels	.attr("x", function(data) { return data.x; })
									.attr("y", function(data) { return data.y; });
							});
	</script>
</body>

</html>