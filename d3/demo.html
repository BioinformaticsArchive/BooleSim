<html>

<head>
	<script src="d3.v2.js"></script>
	<link type="text/css" rel="stylesheet" href="force.css"/>
	<script src="network.js"></script>
</head>

<body>
	<script>
	var	width = 960,
		height = 900;

	var color = d3.scale.category20();

	var force = d3.layout.force()
						.charge(-200)
						.linkDistance(30)
						.size([width, height]);

	var svg = d3.select("body").append("svg")
								.attr("width", width)
								.attr("height", height);

	console.log(network.nodes.length+' nodes')
	console.log(network.edges.length+' edges');

	for (i in network.nodes) {
		n = network.nodes[i];
		n.index = i;
		n.x = 10;
		n.y = 10;
		n.px = 1;
		n.py = 1;
		n.fixed = false;
		n.weight = 1;
		}

	function getNodeById(id) {
		for (i in network.nodes) {
			if (network.nodes[i].id == id || network.nodes[i] == id)
				return network.nodes[i];
			}
		console.error('node '+id+' not found. created.');
		return network.nodes.append( {'index':network.nodes.length, 'x':1, 'y':1, 'fixed':false} );
		}

	for (i in network.edges) {
		network.edges[i].sourceNode = getNodeById(network.edges[i].source);
		network.edges[i].targetNode = getNodeById(network.edges[i].target);
		}

	force
	      .nodes(network.nodes)
	      .links(network.edges)
	      .start();

	// link.source/target is expected as index of a node

	  var links = svg.selectAll("line.link")
							.data(network.edges).enter()
								.append("line")
								.attr("class", "link")
								.style("stroke-width", 1);
    
	var w = 60;
	var h = 20;
	var nodes = svg.selectAll("rect.node")
							.data(network.nodes).enter()
								.append("rect")
								.attr("class", "node")
								.attr("width", w)
								.attr("height",  h)
								.attr("rx", 5)
								.style("fill", "green")
								.call(force.drag);

	  /*nodes.append("title").text(
						function(n) { return n.id; }
						);
						*/

	  force.on("tick", function() {
						    links	.attr("x1", function(e) { return e.sourceNode.x+w/2; })
								.attr("y1", function(e) { return e.sourceNode.y+h/2; })
								.attr("x2", function(e) { return e.targetNode.x+w/2; })
								.attr("y2", function(e) { return e.targetNode.y+h/2; });

						    nodes	.attr("x", function(n) { return n.x; })
								.attr("y", function(n) { return n.y; });
						  });
	</script>
</body>

</html>